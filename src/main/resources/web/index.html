<!DOCTYPE html>
<html>
<head>
    <title>Hap-PI-ness</title>

    <style type="text/css">
        html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
    </style>

    <script src="http://cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
    <script src="vertxbus-2.1.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="datamaps.all.js"></script>
    <script>

        window.onload = init;

        function init() {

            console.log('In init() innit');

            // Get a handle to the eventbus
            var eb = new vertx.EventBus(window.location+'eventbus');
            console.log('Got event bus handle');
            var image = "small-dot-icon.png";

            // When the eventbus is ready, register a listener
            eb.onopen = function() {

                console.log('Socket to vert.x EventBus opened');

                // Register for server events
                eb.registerHandler('msg.server', function(message) {

                    //console.log(JSON.stringify(message));

                    // If the message has geo data...
                    if (null != message.coordinates) {

                        // Coords are ordered long, lat
                        var tweetLong = message.coordinates.coordinates[0];
                        var tweetLat = message.coordinates.coordinates[1];
                        var sentimentScore = parseInt(message.sentimentScore);

                        //console.log("Lat: " + tweetLat + ", Long: " + tweetLong + ", SentimentScore: " + sentimentScore);

                        //if (sentimentScore < 0) {
                        //    console.log("Negative tweet: " + sentimentScore);
                        // }

                        // Construct the tweet location and briefly plot it
                        //var tweetLocation = new google.maps.LatLng(tweetLat, tweetLong);
                        var marker = [{
                            latitude: tweetLat,
                            longitude: tweetLong,
                            radius: 50,
                            fillKey: 'MARKER'

                        }];
                        map.bubbles(marker);

                        setTimeout(function(){
                            map.bubbles([]);
                        }, 50);

                    }
                    //$('#tweets').prepend('<p>'+message.user.screen_name+': '+message.positivity+'</p>');
                    //if ($('#tweets p').length >20) {
                    //    $('#tweets p:last').remove();
                    //}
                });
                console.log('Registered handler for msg.server channel')
            }

        }

    </script>
</head>
<body>

<div id="container" style="position: relative; height: 90%;"></div>
<script>
    var map = new Datamap({
        element: document.getElementById('container'),
        fills: {
            HIGH: '#afafaf',
            LOW: '#123456',
            MEDIUM: 'blue',
            UNKNOWN: 'rgb(0,0,0)',
            MARKER: 'red',
            defaultFill: 'black'
        }/*,
        data: {
            IRL: {
                fillKey: 'HIGH',
                numberOfThings: 2002
            },
            USA: {
                fillKey: 'MEDIUM',
                numberOfThings: 10381
            }
        }*/

    });

    //draw a legend for this map
    map.legend();
</script>


</body>
</html>