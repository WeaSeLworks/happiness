<!DOCTYPE html>
<html>
<head>
    <title>Hap-PI-ness</title>

    <style type="text/css">
        html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
    </style>

    <script src="http://cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
    <script src="vertxbus-2.1.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

    <!-- Google Maps -->
    <link href="https://google-developers.appspot.com/maps/documentation/javascript/examples/default.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbE6pTxk-WK-iIyhfcDlWFMd3k4NGuMEw">
    </script>

    <!-- Google Maps Visualisation Library (for Heatmap Layer) -->
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?libraries=visualization&sensor=true_or_false">
    </script>

    <script>

        var heatmap;
        var liveTweets;
        var map;

        window.onload = init;

        function init() {

            console.log('In init() innit');

            // Get a handle to the eventbus
            var eb = new vertx.EventBus(window.location+'eventbus');
            console.log('Got event bus handle');

            // When the eventbus is ready, register a listener
            eb.onopen = function() {

                console.log('Socket to vert.x EventBus opened');

                // Register for server events
                eb.registerHandler('msg.server', function(message) {

                    //console.log(JSON.stringify(message));

                    // If the message has geo data...
                    if (null != message.coordinates) {

                        // Coords are ordered long, lat
                        var tweetLong = message.coordinates.coordinates[0];
                        var tweetLat = message.coordinates.coordinates[1];
                        var positivity = parseInt(message.positivity);

                        //console.log("Lat: " + tweetLat + ", Long: " + tweetLong + ", Positivity: " + positivity);

                        // Construct the tweet location and briefly plot it
                        var tweetLocation = new google.maps.LatLng(tweetLat, tweetLong);

                        var image = "small-dot-icon.png";
                        var marker = new google.maps.Marker({
                            position: tweetLocation,
                            map: map,
                            icon: image
                        });
                        setTimeout(function(){
                            marker.setMap(null);
                        },600);

                        // Now construct a weighted location based on the positivity score
                        // and push that to the heatmap
                        var weightedLocation = {location: tweetLocation, weight: positivity};
                        liveTweets.push(weightedLocation);


                    }
                    //$('#tweets').prepend('<p>'+message.user.screen_name+': '+message.positivity+'</p>');
                    //if ($('#tweets p').length >20) {
                    //    $('#tweets p:last').remove();
                    //}
                });
                console.log('Registered handler for msg.server channel')
            }

        }

        function initMap() {

            //Setup Google Map
            var myLatlng = new google.maps.LatLng(17.7850,-12.4183);
            var light_grey_style = [{"featureType":"landscape","stylers":[{"saturation":-100},{"lightness":65},{"visibility":"on"}]},{"featureType":"poi","stylers":[{"saturation":-100},{"lightness":51},{"visibility":"simplified"}]},{"featureType":"road.highway","stylers":[{"saturation":-100},{"visibility":"simplified"}]},{"featureType":"road.arterial","stylers":[{"saturation":-100},{"lightness":30},{"visibility":"on"}]},{"featureType":"road.local","stylers":[{"saturation":-100},{"lightness":40},{"visibility":"on"}]},{"featureType":"transit","stylers":[{"saturation":-100},{"visibility":"simplified"}]},{"featureType":"administrative.province","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"labels","stylers":[{"visibility":"on"},{"lightness":-25},{"saturation":-100}]},{"featureType":"water","elementType":"geometry","stylers":[{"hue":"#ffff00"},{"lightness":-25},{"saturation":-97}]}];
            var myOptions = {
                zoom: 2,
                center: myLatlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                    position: google.maps.ControlPosition.LEFT_BOTTOM
                },
                styles: light_grey_style
            };

            console.log('Instantiating map');
            map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
            console.log('Map created: ' + map);

            // Initialise heat map and link to Twitter array we will append data to
            liveTweets = new google.maps.MVCArray();
            heatmap = new google.maps.visualization.HeatmapLayer({
                data: liveTweets,
                radius: 25
            });
            heatmap.setMap(map);

            console.log('initMap() completed');


        }
        google.maps.event.addDomListener(window, 'load', initMap);
    </script>
</head>
<body>

<div id="map_canvas" style="height: 80%"></div>

<!--div id="fromserver" class="main">
    <label for="tweets">Tweets with greater than zero positivity: </label>
    <div id="tweets"></div>
</div-->

</body>
</html>