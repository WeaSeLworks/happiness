<!DOCTYPE html>
<html>
<head>
    <title>Hap-PI-ness</title>

    <style type="text/css">
        html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
    </style>

    <script src="http://cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
    <script src="vertxbus-2.1.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="datamaps.world.min.js"></script>
    <script>

        var map;

        var choroplethToKeyFillMap = {
            "-5" : "UNHAPPY5",
            "-4" : "UNHAPPY4",
            "-3" : "UNHAPPY3",
            "-2" : "UNHAPPY2",
            "-1" : "UNHAPPY1",
            "0"  : "NEUTRAL",
            "1"  : "HAPPY1",
            "2"  : "HAPPY2",
            "3"  : "HAPPY3",
            "4"  : "HAPPY4",
            "5"  : "HAPPY5"
        }

        window.onload = init;

        function init() {

            console.log('In init() innit');

            // Get a handle to the eventbus
            var eb = new vertx.EventBus(window.location+'eventbus');
            console.log('Got event bus handle');
            var image = "small-dot-icon.png";

            // When the eventbus is ready, register a listener
            eb.onopen = function() {

                console.log('Socket to vert.x EventBus opened');

                // Register for server events
                eb.registerHandler('msg.server', function(message) {

                    //console.log(JSON.stringify(message));

                    // Coords are ordered long, lat
                    var tweetLong = message.tweetLong;
                    var tweetLat = message.tweetLat;
                    var choroplethScore = message.choroplethScore;
                    var countryCode = message.countryCode;

                    //console.log("Lat: " + tweetLat + ", Long: " + tweetLong + ", Score: " + choroplethScore);

                    //if (sentimentScore < 0) {
                    //    console.log("Negative tweet: " + sentimentScore);
                    // }

                    // Construct the tweet location and briefly plot it
                    //var tweetLocation = new google.maps.LatLng(tweetLat, tweetLong);
                    var marker = [{
                        latitude: tweetLat,
                        longitude: tweetLong,
                        radius: 20,
                        fillKey: 'MARKER'

                    }];
                    //map.bubbles(marker);

                    setTimeout(function(){
                        map.bubbles([]);
                    }, 10);

                    var jsonData = {};
                    var countryFillKey = {};
                    countryFillKey['fillKey'] = choroplethToKeyFillMap[choroplethScore];
                    jsonData[countryCode] = countryFillKey;

                    //console.log("Data: " + JSON.stringify(jsonData));
                    map.updateChoropleth(jsonData);


                });
                console.log('Registered handler for msg.server channel')
            }

        }

    </script>
</head>
<body>

<div id="container" style="position: relative; height: 90%;"></div>
<script>
    map = new Datamap({
        element: document.getElementById('container'),
        fills: {
            "MARKER": 'red',
            "UNHAPPY5": 'rgb(165,0,38)',
            "UNHAPPY4": 'rgb(215,48,39)',
            "UNHAPPY3": 'rgb(244,109,67)',
            "UNHAPPY2": 'rgb(253,174,97)',
            "UNHAPPY1": 'rgb(254,224,139)',
            "NEUTRAL": 'rgb(255,255,191)',
            "HAPPY1": 'rgb(217,239,139)',
            "HAPPY2": 'rgb(166,217,106)',
            "HAPPY3": 'rgb(102,189,99)',
            "HAPPY4": 'rgb(26,152,80)',
            "HAPPY5": 'rgb(0,104,55)'

        },
        data: {
        }

    });

    //draw a legend for this map
    map.legend();

</script>


</body>
</html>